<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zen-Tap 全息场</title>
  <link rel="icon" href="zen-tap-ico.png" type="image/x-icon">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      background: #704c91; 
      font-family: 'Helvetica Neue', Arial, sans-serif; 
    }
    .container { 
      position: relative; 
      width: 100vw; 
      height: 100vh; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
    }
    .logo { 
      font-size: 12rem; 
      font-weight: 700; 
      color: white; 
      text-align: center; 
      text-shadow: 0 1px 2px rgba(0,0,0,.3); 
      letter-spacing: 2px; 
      z-index: 10; 
    }
    .instruction { 
      font-size: 2rem; 
      color: white; 
      text-align: center; 
      margin-top: 20px; 
      text-shadow: 0 2px 10px rgba(0,0,0,.3); 
    }
    .circle { 
      position: absolute; 
      border-radius: 50%; 
      cursor: pointer; 
      transition: all .5s ease; 
    }
    .circle:hover { opacity: .9; transform: scale(1.05); }
    .circle.color-1 { background: rgba(102,178,255,.6); }
    .circle.color-2 { background: rgba(144,204,144,.6); }
    .circle.color-3 { background: rgba(255,179,179,.6); }
    .circle.color-4 { background: rgba(179,144,255,.6); }
    .circle.color-5 { background: rgba(255,204,128,.6); }
    .circle.color-6 { background: rgba(184,219,230,.6); }
    .circle[data-animation] { animation: var(--breathe-animation) var(--breathe-duration) infinite ease-in-out; }
    @keyframes breathe1 { 0%,100%{transform:scale(1);opacity:.4;} 50%{transform:scale(2.2);opacity:.8;} }
    @keyframes breathe2 { 0%,100%{transform:scale(1);opacity:.3;} 50%{transform:scale(2.5);opacity:.7;} }
    @keyframes breathe3 { 0%,100%{transform:scale(1);opacity:.5;} 50%{transform:scale(2);opacity:.9;} }
    @media (max-width:768px) { 
      .logo { font-size: 6rem; } 
      .instruction { font-size: 1.5rem; } 
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="logo">Zen-Tap</div>
    <div class="instruction">点击任意圆形获取全息信息</div>
  </div>
  <script src="public/js/scripts/app.js"></script>
  <script>
    const container = document.getElementById('container');
    const circleCount = 6;
    const colors = ['color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6'];
    let circles = [];
    
    function genUID() { return 'U' + Math.random().toString(36).slice(2, 10); }
    
    function shuffleArray(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    
    function createCircles() {
      circles.forEach(c => c.remove());
      circles = [];
      
      const sizes = shuffleArray(Array.from({ length: circleCount }, (_, i) => 
        Math.min(container.offsetWidth, container.offsetHeight) * (1 - i * .1) * .25
      ));
      
      const placed = [], colorAs = shuffleArray([...colors]);
      
      for (let i = 0; i < circleCount; i++) {
        const c = document.createElement('div');
        c.classList.add('circle', colorAs[i]);
        c.setAttribute('data-animation', (Math.floor(Math.random() * 3) + 1));
        
        const size = sizes[i], duration = 7 + Math.random() * 2;
        c.style.setProperty('--breathe-duration', `${duration}s`);
        c.style.setProperty('--breathe-animation', `breathe${Math.floor(Math.random() * 3) + 1}`);
        
        const pos = findPos(size, placed);
        c.style.width = c.style.height = `${size}px`;
        c.style.left = `${pos.x}px`;
        c.style.top = `${pos.y}px`;
        c.dataset.id = i + 1;
        
        c.addEventListener('click', async (e) => {
          const ts = Date.now();
          const uid = localStorage.getItem('zen_uid') || genUID();
          if (!localStorage.getItem('zen_uid')) localStorage.setItem('zen_uid', uid);
          const ip = window.__ZEN_TAP_CLIENT_IP || '0.0.0.0';
          const x = Math.round(e.clientX), y = Math.round(e.clientY);
          
          // 使用app.js的generateHexagramResult处理数据
          const result = await ZenTap.generateHexagramResult({
            timestamp: ts,
            uid: uid,
            ip: ip
          });
          
          c.style.transform = 'scale(2.5)';
          c.style.opacity = '0';
          
          // 将完整结果和点击坐标传递给main.html
          const params = new URLSearchParams({
            seed: `${ts}|${ip}|${uid}|${c.dataset.id}|${x},${y}`,
            timestamp: ts,
            uid: uid,
            ip: ip,
            x: x,
            y: y,
            circleId: c.dataset.id,
            hexagramResult: JSON.stringify(result)
          });
          
          setTimeout(() => location.href = `main.html?${params.toString()}`, 500);
        });
        
        placed.push({ x: pos.x, y: pos.y, radius: size / 2 });
        container.appendChild(c);
        circles.push(c);
      }
    }
    
    function findPos(size, placed) {
      const maxA = 200;
      let a = 0, radius = size / 2;
      
      while (a < maxA) {
        const x = Math.random() * (container.offsetWidth - size);
        const y = Math.random() * (container.offsetHeight - size);
        
        if (placed.every(p => 
          Math.sqrt((p.x - x) ** 2 + (p.y - y) ** 2) >= (p.radius + radius + 10)
        )) return { x, y };
        
        a++;
      }
      
      return {
        x: Math.random() * (container.offsetWidth - size),
        y: Math.random() * (container.offsetHeight - size)
      };
    }
    
    window.addEventListener('resize', createCircles);
    document.addEventListener('keydown', e => e.key.toLowerCase() === 'r' && createCircles());
    document.addEventListener('DOMContentLoaded', createCircles);
  </script>
</body>
</html>